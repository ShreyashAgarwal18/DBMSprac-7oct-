-- Reset the database
DROP DATABASE IF EXISTS assg4;
CREATE DATABASE assg4;
USE assg4;

-- Create tables
CREATE TABLE N_RollCall (
    RollNo INT PRIMARY KEY,
    Name VARCHAR(50),
    Branch VARCHAR(20),
    Year INT,
    Attendance_Percentage DECIMAL(5,2),
    Event VARCHAR(30)
);

CREATE TABLE O_RollCall (
    RollNo INT PRIMARY KEY,
    Name VARCHAR(50),
    Branch VARCHAR(20),
    Year INT,
    Attendance_Percentage DECIMAL(5,2),
    Event VARCHAR(30)
);

-- Insert sample data
INSERT INTO N_RollCall VALUES
(101, 'Ravi Kumar', 'Computer', 2, 65.00, 'Cultural'),
(102, 'Sneha Patel', 'Mechanical', 3, 78.00, 'Sports'),
(103, 'Aman Singh', 'Computer', 1, 55.00, 'Cultural'),
(104, 'Priya Sharma', 'Electrical', 2, 85.00, 'TechFest');

INSERT INTO O_RollCall VALUES
(201, 'Rahul Verma', 'Computer', 3, 72.00, 'Cultural'),
(202, 'Anita Joshi', 'Mechanical', 2, 69.00, 'Sports'),
(101, 'Ravi Kumar', 'Computer', 2, 65.00, 'Cultural');

-- Create procedure safely
DELIMITER $$
CREATE PROCEDURE MergeRollCall()
BEGIN
    DECLARE done INT DEFAULT 0;
    DECLARE v_roll INT;
    DECLARE v_name VARCHAR(50);
    DECLARE v_branch VARCHAR(20);
    DECLARE v_year INT;
    DECLARE v_att DECIMAL(5,2);
    DECLARE v_event VARCHAR(30);
    DECLARE count_exists INT DEFAULT 0;

    DECLARE cur CURSOR FOR
        SELECT RollNo, Name, Branch, Year, Attendance_Percentage, Event FROM N_RollCall;

    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;

    OPEN cur;

    merge_loop: LOOP
        FETCH cur INTO v_roll, v_name, v_branch, v_year, v_att, v_event;
        IF done THEN
            LEAVE merge_loop;
        END IF;

        -- Check if RollNo already exists before inserting
        SELECT COUNT(*) INTO count_exists FROM O_RollCall WHERE RollNo = v_roll;

        IF count_exists = 0 THEN
            INSERT INTO O_RollCall VALUES (v_roll, v_name, v_branch, v_year, v_att, v_event);
        END IF;

    END LOOP;

    CLOSE cur;
END$$
DELIMITER ;

-- Execute the procedure
CALL MergeRollCall();

-- See the merged result
SELECT * FROM O_RollCall;
